## MirAI Trade – Backtest TIPS

> **目的** : パラメータサーチを再現性高く、かつ短時間で回し、Sharpe・勝率のボトルネックをすぐ特定できるようにする。
>
> **前提** : 取引営業日は `trading_days_fetcher.py`、価格データは `price_ohlcv_derived.csv`（90営業日）を使用。

---

### 1. フロー早見表

| フェーズ            | コマンド                                                              | 所要      | 成果物                            |
| --------------- | ----------------------------------------------------------------- | ------- | ------------------------------ |
| **F1. 派生列生成**   | `python -m app.backtest.add_derived_cols`                         | 30 sec  | `price_ohlcv_derived.csv`      |
| **F2. 粗グリッド探索** | `python -m app.backtest.param_search --coarse`                    | 3–4 min | `backtest_results/coarse.json` |
| **F3. 精密グリッド**  | `python -m app.backtest.param_search --fine --base <best‑coarse>` | 4–5 min | `param_report.txt`             |
| **F4. リザルト集計**  | `python -m app.backtest.report_summary`                           | <1 min  | `summary.xlsx`                 |

> *粗→精 の2段サーチで **16 並列**なら合計 \~10 分。*

---

### 2. 測定指標（必須基準）

| 指標                | 目標値                   | 説明                    |
| ----------------- | --------------------- | --------------------- |
| **勝率**            | ≥ 55 %（最低 50 % で暫定採用） | 取引回数 ‑ 勝ち数 ÷ 全取引      |
| **平均日次リターン**      | ≥ +5 %                | コスト 0.2 % 控除後         |
| **シャープレシオ (年換算)** | ≥ 1.5                 | 日次リターン ×√250 ÷ σ      |
| **最大ドローダウン**      | ≤ 15 %                | Cumulative Max vs Min |
| **総トレード数**        | ≥ 1 800/年             | サンプル不足防止              |

---

### 3. 推奨レンジ & ステップ幅

| パラメータ                           | レンジ                      | ステップ               | メモ                |
| ------------------------------- | ------------------------ | ------------------ | ----------------- |
| **c (Momentum\_3\_pos 係数)**     | 0.6 – 2.8                | 0.2 (粗) → 0.05 (精) | c↑ : 連騰銘柄を優遇      |
| **d (PullUp 係数)**               | 0.4 – 1.8                | 0.2 → 0.05         | d↑ : 終値がレンジ上半分を加点 |
| **ATR\_ratio (ATR\_3/ATR\_10)** | clip 0.5–3               | —                  | 係数固定 1.6          |
| **Range\_penalty**              | log1p(1+Range) ^ 2.0–2.4 | 0.1                | 2.2 が経験的中央値       |
| **NK225\_gap weight**           | ±0.02 clip               | —                  | 市場ギャップ反映倍率 1.0    |

---

### 4. チューニング手順（実践）

1. **粗探索** — c,d を広めに回し「勝率 ≥48 % & Sharpe ≥0.4」を満たす上位 15 組を抽出。
2. **候補絞込** — 上位 15 組の *c,d* 中央値 ±0.2 を精密レンジに設定。
3. **精密探索** — 0.05 ステップで再走、基準値クリア組を CSV に保存。
4. **感度分析** — `summary.xlsx` のヒートマップで c,d 平面を可視化。※1σ 内でシャープ低下が小さい領域を選ぶ。
5. **90 日 forward run** — 最良パラメータ 1 組で直近 90 日を走らせ、基準再チェック。
6. **β リリース** — 50 % 以上なら 1 週間紙運用。55 % 超えで本番採用。

---

### 5. よくある失敗パターン

| 症状                    | 原因                               | 対策                             |
| --------------------- | -------------------------------- | ------------------------------ |
| 勝率は高いが Sharpe < 1     | トレード数が少ない / ボラ低い銘柄比率増            | TopN を 40→50 に緩めてサンプル確保        |
| Sharpe は良いが DD > 20 % | 上下限 clip が緩く NK225\_gap に引っ張られ過ぎ | Gap clip ±0.015 に縮小            |
| 探索に 30 分以上かかる         | 期間 180 days & 並列 8               | 期間 90 days & n\_jobs=CPU/2 に変更 |

---

### 6. バックテスト Tips

* **営業日取得は必ず `trading_days_fetcher.py`**（自前暦禁止）。
* **API 呼び出し**は `*_fetcher.py` → `configs/config.yaml` → `config.py` 経由で URL 決定。
* 新パラメータを追加する場合は `param_search.py` → `backtest_runner.py` → `score_up.py` の 3 点を一括修正。

---

> 最終投資判断はご自身で行ってください。
> （2025‑06‑28 更新）
